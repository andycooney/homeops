---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kopia-s3-sync
  namespace: default
spec:
  schedule: "0 */12 * * *"
  suspend: false
  concurrencyPolicy: "Forbid"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          automountServiceAccountToken: false
          restartPolicy: OnFailure
          containers:
            - name: sync
              image: ghcr.io/onedr0p/kopia:0.11.3@sha256:db13525a2779b77e4c1db2e14470a369a2c8c9ebac575706c1141f0a786c7f62
              env:
                - name: TZ
                  value: "${TIMEZONE}"
                - name: KOPIA_CACHE_DIRECTORY
                  value: /data/backups/cache
                - name: KOPIA_LOG_DIR
                  value: /data/backups/logs
                - name: KOPIA_PASSWORD
                  value: "none"
              command:
                - /bin/bash
                - -c
                - |
                  printf "\e[1;32m%-6s\e[m\n" "[01/02] Connect to repo ..."      && kopia repo connect filesystem --path=/data/backups --override-hostname=cluster --override-username=root
                  printf "\e[1;32m%-6s\e[m\n" "[02/02] Sync to s3 ..."           && kopia repo sync-to from-config --file=/config/s3.config --delete
                  printf "\e[1;32m%-6s\e[m\n" "[09/09] Disconnect from repo ..." && kopia repo disconnect
              volumeMounts:
                - name: backups
                  mountPath: /data/backups
                - name: config
                  mountPath: /config
              securityContext:
                privileged: true
          volumes:
            - name: backups
              nfs:
                server: "expanse.${SECRET_PRIVATE_DOMAIN}"
                path: /tycho/Apps/External/Backups/kopia
            - name: config
              projected:
                defaultMode: 0775
                sources:
                  - configMap:
                      name: kopia
                      items:
                        - key: repository.config
                          path: repository.config
                  - secret:
                      name: kopia-s3
                      items:
                        - key: s3.config
                          path: s3.config
