---

- hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: "Run k3s-killall.sh"
      command: k3s-killall.sh

    - name: "Run k3s-uninstall.sh"
      command:
        cmd: k3s-uninstall.sh
        removes: /usr/local/bin/k3s-uninstall.sh

    - name: "Run k3s-agent-uninstall.sh"
      command:
        cmd: k3s-agent-uninstall.sh
        removes: /usr/local/bin/k3s-agent-uninstall.sh
    
    - name: "Clean up Docker"
      command: docker system prune -a --force

    - name: Rebooting hosts
      reboot:
        msg: "Systems are being rebooted"
        reboot_timeout: 60
      ignore_errors: true

    - name: "Clean up Docker (again)"
      command: docker system prune -a --force

# https://rook.io/docs/rook/v0.9/ceph-teardown.html
# sudo su -
# sgdisk --zap-all /dev/nvme0n1
# ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %
# wipefs -af /dev/nvme0n1