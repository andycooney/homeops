---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Lychee"

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: [".github/workflows/lychee.yaml"]
  schedule:
    - cron: "0 0 * * *"

env:
  WORKFLOW_ISSUE_NUMBER: 6587

jobs:
  lychee:
    name: Lychee
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: "${{ steps.app-token.outputs.token }}"

      - name: Find Link Checker Issue
        uses: actions/github-script@v7
        with:
          script: |
            const query = `query($owner:String!, $name:String!, $title:String!) {
              repository(owner:$owner, name:$name){
                issues(first:100, in:$title) {
                  nodes {
                    id
                  }
                }
              }
            }`;
            const variables = {
              owner: context.repo.owner,
              name: context.repo.repo,
              title 'Link Checker Dashboard ðŸ”—'
            }
            const result = await github.graphql(query, variables)
            console.log(result)

      # - name: Scan for broken links
      #   uses: lycheeverse/lychee-action@v1
      #   env:
      #     GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
      #   with:
      #     args: --verbose --no-progress --exclude-mail './**/*.md'
      #     output: /tmp/results.md

      # - name: Update Issue
      #   uses: peter-evans/create-issue-from-file@v4
      #   with:
      #     token: "${{ steps.app-token.outputs.token }}"
      #     title: Link Checker Dashboard ðŸ”—
      #     issue-number: "${{ env.WORKFLOW_ISSUE_NUMBER }}"
      #     content-filepath: /tmp/results.md
