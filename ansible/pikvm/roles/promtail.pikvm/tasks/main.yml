---
- name: Create promtail directories
  ansible.builtin.file:
    path: /etc/promtail
    state: directory

- name: Check current promtail version
  ansible.builtin.command: "/usr/local/bin/promtail --version"
  failed_when: false
  changed_when: false
  register: promtail_version_check

- name: Download and unarchive promtail into temporary location
  ansible.builtin.unarchive:
    src: "{{ promtail_download_url }}"
    dest: /tmp
    remote_src: true
    mode: 0755
  when: >
    promtail_version_check.stdout is not defined
    or promtail_version not in promtail_version_check.stdout
  register: promtail_download_check

- name: Move promtail binary into place
  ansible.builtin.copy:
    src: "/tmp/promtail-linux-{{ promtail_arch }}"
    dest: /usr/local/bin/promtail
    mode: 0755
    remote_src: true
  notify: Restart promtail
  when: promtail_download_check is defined

- block:
    - name: Copy promtail config
      ansible.builtin.template:
        src: promtail.yaml.j2
        dest: /etc/promtail/promtail.yaml
        mode: 0755
    - name: Create promtail systemd file
      ansible.builtin.template:
        src: promtail.service.j2
        dest: /etc/systemd/system/promtail.service
        mode: 0644
  notify: Restart promtail
