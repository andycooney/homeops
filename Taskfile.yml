---
version: "3"

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"
  ANSIBLE_DIR: "{{.PROJECT_DIR}}/ansible"
  CLUSTER_DIR: "{{.PROJECT_DIR}}/kubernetes"

env:
  KUBECONFIG: "{{.ANSIBLE_DIR}}/kubernetes/kubeconfig"

includes:
  cluster: .taskfiles/ClusterTasks.yml
  debug: .taskfiles/DebugTasks.yml
  rook: .taskfiles/RookTasks.yml
  volsync: .taskfiles/VolSync/Tasks.yml

tasks:
  kubeconfig:
    desc: Remotely fetch kubeconfig from Kubernetes
    vars:
      MASTER_USERNAME: '{{.MASTER_USERNAME | default "root"}}'
      MASTER_HOST: '{{.MASTER_HOST | default "192.168.42.10"}}'
      KUBERNETES_API: '{{.KUBERNETES_API | default "192.168.1.1"}}'
    cmds:
      - rsync --verbose --progress --partial --rsync-path="sudo rsync" {{.MASTER_USERNAME}}@{{.MASTER_HOST}}:/etc/rancher/k3s/k3s.yaml "${KUBECONFIG}"
      - sed -i '' 's/127.0.0.1/{{.KUBERNETES_API}}/g' "${KUBECONFIG}"
      - chmod go-r "${KUBECONFIG}"

  ansible:
    desc: Install/Upgrade Ansible deps
    dir: '{{.ANSIBLE_DIR}}'
    cmds:
      - ansible-galaxy install -r requirements.yml --roles-path ~/.ansible/roles --force
      - ansible-galaxy collection install -r requirements.yml --collections-path ~/.ansible/collections --force
    preconditions:
      - test -f "{{.ANSIBLE_DIR}}/requirements.yml"

  es:
    desc: Reconcile all ExternalSecret resources
    vars:
      secret: '{{ .secret | default ""}}'
      namespace: '{{.namespace | default "default"}}'
    cmds:
      - |
        {{if eq .secret ""}}
          kubectl get externalsecret.external-secrets.io --all-namespaces --no-headers -A | awk '{print $1, $2}' \
            | xargs -l bash -c 'kubectl -n $0 annotate externalsecret.external-secrets.io $1 force-sync=$(date +%s) --overwrite'
        {{else}}
          kubectl -n {{.namespace}} annotate externalsecret.external-secrets.io {{.secret}} force-sync=$(date +%s) --overwrite
        {{end}}
    preconditions:
      - kubectl -n {{.namespace}} get es {{.secret}}

  fx:
    desc: Reconcile all Flux resources
    cmds:
      - |
        kubectl get gitrepositories --all-namespaces --no-headers -A | awk '{print $1, $2}' \
          | xargs --max-procs=4 -l bash -c \
            'kubectl -n $0 annotate gitrepositories $1 reconcile.fluxcd.io/requestedAt=$(date +%s) --field-manager=flux-client-side-apply --overwrite'
      - |
        kubectl get kustomization --all-namespaces --no-headers -A | awk '{print $1, $2}'
          | xargs --max-procs=4 -l bash -c \
            'kubectl -n $0 annotate kustomization $1 reconcile.fluxcd.io/requestedAt="$(date +%s)" --field-manager=flux-client-side-apply --overwrite'
