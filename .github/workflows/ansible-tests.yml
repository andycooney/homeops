---

name: ansible-tests

on:
  workflow_dispatch:
  push:
    branches:
    - main
    paths:
    - 'ansible/**'

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
  ANSIBLE_HOST_KEY_CHECKING: "False"

# defaults:
#   run:
#     working-directory: ./ansible/tests

jobs:
  cloud-resources:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - name: Install yq
      run: |
        curl -sL -o yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
        sudo mv yq /usr/local/bin
        chmod +x /usr/local/bin/yq
        yq --version

    - name: Install Pulumi
      run: |
        curl -fsSL https://get.pulumi.com | sh
        sudo mv /home/runner/.pulumi/bin/pulumi /usr/local/bin
        pulumi version

    - name: Install npm deps
      working-directory: ./ansible/tests
      run: npm install

    - name: Change Pulumi stack
      working-directory: ./ansible/tests
      run: pulumi stack select ubuntu-2010

    - name: Create cloud resources
      working-directory: ./ansible/tests
      run: pulumi up --yes

    - name: Save Ansible inventory
      working-directory: ./ansible/tests
      run: pulumi stack output --json | yq eval -P - > /tmp/hosts.yml

    - name: Upload Ansible inventory
      uses: actions/upload-artifact@v2
      with:
        name: hosts
        path: /tmp/hosts.yml

  ansible-playbook:
    needs:
    - cloud-resources
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Upgrade pip and display Python and PIP versions
      run: |
        sudo apt-get update
        sudo apt-get install -y python*-wheel python*-yaml
        python3 -m pip install --upgrade pip
        python3 -V
        pip --version

    - name: Upgrade Ansible
      run: |
        python3 -m pip install --force-reinstall --upgrade 'ansible>=3.0.0'
        ansible --version

    - name: Install mitogen
      working-directory: ./ansible
      run: |
        curl -#L -o mitogen.tar.gz https://github.com/mitogen-hq/mitogen/archive/v0.3.0rc1.tar.gz
        tar -xzf mitogen.tar.gz

    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.5.0
      with:
        ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}

    - name: Download Ansible inventory
      uses: actions/download-artifact@v2
      with:
        name: hosts
        path: /tmp/hosts.yml

    - name: Waiting for all hosts to become ready
      uses: nick-invision/retry@v2
      with:
        timeout_seconds: 15
        max_attempts: 4
        retry_on: error
        command: ansible all -i /tmp/hosts.yml --one-line -m ping

    - name: Run playbook
      working-directory: ./ansible
      run: ansible-playbook -i /tmp/hosts.yml ./playbooks/ubuntu/prepare.yml

  cleanup:
    needs:
    - cloud-resources
    - ansible-playbook
    if: always()
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - name: Install Pulumi
      run: |
        curl -fsSL https://get.pulumi.com | sh
        sudo mv /home/runner/.pulumi/bin/pulumi /usr/local/bin
        pulumi version

    - name: Install npm deps
      working-directory: ./ansible/tests
      run: npm install

    - name: Change Pulumi stack
      working-directory: ./ansible/tests
      run: pulumi stack select ubuntu-2010

    - name: Destroy cloud resources
      working-directory: ./ansible/tests
      run: pulumi destroy --yes
