---

name: pulumi

on:
  workflow_dispatch:
  push:
    branches:
    - main
    # paths:
    # - "ansible/**"

# PULUMI_ACCESS_TOKEN
# DIGITALOCEAN_TOKEN

defaults:
  run:
    working-directory: ./ansible

jobs:
  test-ubuntu-prepare:

    runs-on:
    - ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1

    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install software-properties-common
        sudo apt-add-repository --yes --update ppa:ansible/ansible
        sudo apt install ansible
        ansible --version

    - name: Install Pulumi
      run: |
        curl -fsSL https://get.pulumi.com | sh
        sudo mv /home/runner/.pulumi/bin/pulumi /usr/local/bin
        pulumi version

    - name: Install yq
      run: |
        curl -sL -o yq "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
        sudo mv yq /usr/local/bin
        chmod +x /usr/local/bin/yq
        yq --version

    - name: Install go-task
      run: |
        curl -fsSL https://taskfile.dev/install.sh | sh
        sudo mv ./bin/task /usr/local/bin
        task --version

    - name: Run Tests
      working-directory: ./ansible/tests
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      run: |
        bash run-test.sh

    - name: Clean up
      working-directory: ./ansible/tests
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      run: |
        bash run-test.sh
