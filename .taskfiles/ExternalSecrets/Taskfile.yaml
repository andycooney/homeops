---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:

  sync:
    desc: Sync ExternalSecret resources
    summary: task {{.TASK}} [cluster=main] [ns=default]? [secret=plex]?
    cmd: |
      {{if eq .secret ""}}
        {{.KUBECTL}} get externalsecret --all-namespaces --no-headers -A | awk '{print $1, $2}' \
          | xargs --max-procs=4 -l bash -c '{{.KUBECTL}} -n $0 annotate externalsecret $1 force-sync=$(date +%s) --overwrite'
      {{else}}
        {{.KUBECTL}} -n {{.ns}} annotate externalsecret {{.secret}} force-sync=$(date +%s) --overwrite
      {{end}}
    env:
      KUBECONFIG: "{{.KUBERNETES_DIR}}/{{.cluster}}/kubeconfig"
    vars:
      cluster: '{{ or .cluster (fail "Argument (cluster) is required") }}'
      ns: '{{.ns | default "default"}}'
      secret: '{{ .secret | default ""}}'
    preconditions:
      - "{{.KUBECTL}} -n {{.ns}} get externalsecret {{.secret}}"
