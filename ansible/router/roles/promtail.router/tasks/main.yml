---
- name: Create promtail directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
    - /usr/local/etc/promtail
    - /var/log/promtail

- name: Check current promtail version
  ansible.builtin.command: "/usr/local/sbin/promtail --version"
  failed_when: false
  changed_when: false
  register: promtail_version_check

- name: Download Promtail
  ansible.builtin.get_url:
    url: "{{ promtail_download_url }}"
    dest: /tmp/promtail-freebsd-amd64.zip
  when: >
    promtail_version_check.stdout is not defined
    or promtail_version not in promtail_version_check.stdout
  register: promtail_download_check

- name: Extract Promtail
  ansible.builtin.shell:
    cmd: unzip /tmp/promtail-freebsd-amd64.zip -d /tmp
  when: >
    promtail_version_check.stdout is not defined
    or promtail_version not in promtail_version_check.stdout
  register: promtail_extract_check

- name: Move promtail binary into place
  ansible.builtin.copy:
    src: /tmp/promtail-freebsd-amd64
    dest: /usr/local/sbin/promtail
    mode: 0755
    remote_src: true
  notify: Restart promtail
  when: >
    promtail_download_check is defined
    and promtail_extract_check is defined

- block:
    - name: Create Promtail config
      ansible.builtin.template:
        src: promtail.yaml.j2
        dest: /usr/local/etc/promtail/promtail.yaml
        mode: 0755
    - name: Create Promtail rc.conf script
      ansible.builtin.template:
        src: promtail-rc.conf.j2
        dest: /etc/rc.conf.d/promtail
        mode: 0755
    - name: Create Promtail rc.d script
      ansible.builtin.template:
        src: promtail-rc.d.j2
        dest: /usr/local/etc/rc.d/promtail
        mode: 0755
    - name: Create Promtail action script
      ansible.builtin.template:
        src: actions_promtail.conf.j2
        dest: /usr/local/opnsense/service/conf/actions.d/actions_promtail.conf
        mode: 0755
    - name: Create Promtail start up script
      ansible.builtin.template:
        src: 99-promtail.j2
        dest: /usr/local/etc/rc.syshook.d/start/99-promtail
        mode: 0755
    - name: Create Promtail log rotation config
      ansible.builtin.template:
        src: promtail-newsyslog.conf.j2
        dest: /etc/newsyslog.conf.d/promtail
        mode: 0755
  notify: Restart promtail
